<% const isDemo = typeof demoMode !== 'undefined' && demoMode; %>
<section class="mt-4">
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3 expected-moves-header">
        <div>
          <h2 class="h4 mb-0" <% if (!isDemo) { %>data-reset-expected-moves title="Reset filters and sorting"<% } %> style="cursor: <%= isDemo ? 'default' : 'pointer' %>; user-select: none;">Expected Moves</h2>
          <p class="text-muted small mb-0">Expected price movements for stock symbols over various periods</p>
          <p class="text-muted small fst-italic mt-1 mb-0 expected-moves-blurb">Values will be refreshed every trading day at 4:15pm ET. Price has a 68% probability of closing between expected levels, and 95% probability between 2 sigma levels.</p>
        </div>
        <div id="expected-moves-date-display" class="text-muted small fst-italic expected-moves-quotes-as-of text-end"></div>
      </div>

      <% if (isDemo) { %>
      <div class="alert alert-danger d-flex align-items-center mb-3" role="alert">
        <i class="fa-solid fa-circle-exclamation me-2"></i>
        <div>
          Expected moves are not available in demo mode. The table below is a sample of what expected moves looks like.
        </div>
      </div>
      <% } %>

      <div class="mb-3 d-flex gap-3 flex-wrap align-items-center">
        <div class="btn-group" role="group" aria-label="Symbol Filter">
          <select id="expected-moves-symbol-filter" class="form-select form-select-sm" <%= isDemo ? 'disabled aria-disabled="true"' : '' %> title="<%= isDemo ? 'Unavailable in demo mode' : '' %>">
            <option value="">All</option>
          </select>
        </div>

        <div class="btn-group" role="group" aria-label="Initial Value Filter">
          <button type="button" class="btn btn-sm btn-outline-secondary active" data-filter="initial-value" data-value="initial" <%= isDemo ? 'disabled aria-disabled="true"' : '' %> title="<%= isDemo ? 'Unavailable in demo mode' : '' %>">
            Initial Value
          </button>
          <button type="button" class="btn btn-sm btn-outline-secondary" data-filter="initial-value" data-value="latest" <%= isDemo ? 'disabled aria-disabled="true"' : '' %> title="<%= isDemo ? 'Unavailable in demo mode' : '' %>">
            Latest Value
          </button>
        </div>

        <div class="btn-group" role="group" aria-label="Expiry Type Filter">
          <button type="button" class="btn btn-sm btn-outline-secondary active" data-filter="expiry-type" data-value="DAILY" <%= isDemo ? 'disabled aria-disabled="true"' : '' %> title="<%= isDemo ? 'Unavailable in demo mode' : '' %>">
            Daily
          </button>
          <button type="button" class="btn btn-sm btn-outline-secondary" data-filter="expiry-type" data-value="WEEKLY" <%= isDemo ? 'disabled aria-disabled="true"' : '' %> title="<%= isDemo ? 'Unavailable in demo mode' : '' %>">
            Weekly
          </button>
          <button type="button" class="btn btn-sm btn-outline-secondary" data-filter="expiry-type" data-value="MONTHEND" <%= isDemo ? 'disabled aria-disabled="true"' : '' %> title="<%= isDemo ? 'Unavailable in demo mode' : '' %>">
            Month End
          </button>
          <button type="button" class="btn btn-sm btn-outline-secondary" data-filter="expiry-type" data-value="MONTHLY" <%= isDemo ? 'disabled aria-disabled="true"' : '' %> title="<%= isDemo ? 'Unavailable in demo mode' : '' %>">
            Monthly
          </button>
          <button type="button" class="btn btn-sm btn-outline-secondary" data-filter="expiry-type" data-value="QUARTERLY" <%= isDemo ? 'disabled aria-disabled="true"' : '' %> title="<%= isDemo ? 'Unavailable in demo mode' : '' %>">
            Quarterly
          </button>
        </div>

        <div class="btn-group" role="group" aria-label="Symbol Actions">
          <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshExpectedMovesButton" title="<%= isDemo ? 'Unavailable in demo mode' : 'Refresh expected moves data' %>" <%= isDemo ? 'disabled aria-disabled="true"' : '' %>>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16" style="vertical-align: text-bottom;">
              <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
              <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
            </svg>
            <span class="ms-1">Expected Moves</span>
          </button>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="addExpectedMoveSymbolButton" <%= isDemo ? 'disabled aria-disabled="true"' : '' %> title="<%= isDemo ? 'Unavailable in demo mode' : '' %>">Add Symbol</button>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="refresh-quotes" title="<%= isDemo ? 'Unavailable in demo mode' : 'Refresh Quotes' %>" aria-label="Refresh Quotes" <%= isDemo ? 'disabled aria-disabled="true"' : '' %>>
            <i class="fa-solid fa-arrow-rotate-right"></i> Quotes
          </button>
        </div>
      </div>

      <% if (isDemo) { %>
      <div class="text-center py-3">
        <div class="text-muted small mb-2">Sample expected moves (demo)</div>
        <img src="/expected-moves-demo.svg" class="img-fluid rounded shadow-sm border border-secondary" alt="Sample expected moves screenshot">
        <div class="text-muted small mt-2">This is a sample of what demo moves looks like.</div>
      </div>
      <% } else { %>
      <div data-expected-moves-table-root class="table-responsive"></div>
      <% } %>
    </div>
  </div>
</section>

<!-- Add Symbol Modal -->
<div class="modal fade" id="addExpectedMoveSymbolModal" tabindex="-1" aria-labelledby="addExpectedMoveSymbolLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="addExpectedMoveSymbolLabel">Add Symbol</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="addExpectedMoveSymbolInput" class="form-label">Symbol</label>
          <input type="text" class="form-control" id="addExpectedMoveSymbolInput" placeholder="e.g., AAPL" autocomplete="off" />
          <div class="form-text">Use the stock ticker symbol. It will be uppercased.</div>
        </div>
        <div class="alert alert-danger d-none" id="addExpectedMoveSymbolError"></div>
      </div>
      <div class="modal-footer bg-dark border-secondary">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="confirmAddExpectedMoveSymbol">OK</button>
      </div>
    </div>
  </div>
  </div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="expectedMovesDeleteModal" tabindex="-1" aria-labelledby="expectedMovesDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="expectedMovesDeleteModalLabel">
          <i class="fa-solid fa-trash me-2"></i> Confirm Delete
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex align-items-center">
          <i class="fa-solid fa-triangle-exclamation text-danger fs-3 me-3"></i>
          <span id="expected-moves-delete-message">Are you sure you want to delete this symbol?</span>
        </div>
      </div>
      <div class="modal-footer bg-dark border-secondary">
        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="expected-moves-confirm-delete" class="btn btn-danger btn-sm">
          <i class="fa-solid fa-trash me-1"></i> Delete
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Refresh Confirmation Modal -->
<div class="modal fade" id="expectedMovesRefreshModal" tabindex="-1" aria-labelledby="expectedMovesRefreshModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="expectedMovesRefreshModalLabel">
          <i class="fa-solid fa-sync-alt me-2"></i> Refresh Expected Moves
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex align-items-center">
          <i class="fa-solid fa-circle-info text-success fs-3 me-3"></i>
          <span>Are you sure you want to update all expected move values? This may take a few moments.</span>
        </div>
      </div>
      <div class="modal-footer bg-dark border-secondary">
        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="expected-moves-confirm-refresh" class="btn btn-success btn-sm">
          <i class="fa-solid fa-check me-1"></i> OK
        </button>
      </div>
    </div>
  </div>
</div>

<% if (!isDemo) { %>
<script src="/expectedMovesClient.js" defer></script>
<% } %>
